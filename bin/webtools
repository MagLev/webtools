#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.expand_path("../../lib", __FILE__))
require 'rack'
require 'web_tools'

# HACK
$LOAD_PATH.unshift("/home/tim/Devel/vmware/rubymirrors/lib/")
if idx = ARGV.index("-t")
  mirror_api = ARGV[idx + 1]
else
  mirror_api = RUBY_ENGINE
end
require "#{mirror_api.downcase}/reflection"
MirrorAPI = Object.const_get(mirror_api.capitalize)
# HACK END

app = Rack::Builder.new do
  WebTools::UI.set :root, File.expand_path("../..", __FILE__)
  ui = WebTools::UI.new
  WebTools.constants.each { |c| WebTools.const_get(c) }

  redirect = proc { |env| [301,
                    {'Content-Type' => 'text/html', 'Location' => '/webtools/'},
                    '<a href="/webtools">Moved permanently</a>'] }
  WebTools::Tool.subclasses.each do |cls|
    map('/webtools/' + cls.display_name) { run cls.new }
  end
  map('/webtools/') { run ui }
  map('/') { run redirect }
end
Rack::Handler.default.run(app, :Port => 9292)
